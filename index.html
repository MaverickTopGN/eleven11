<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marcadores ‚Äî Pro TV (API-Football)</title>
<style>
:root{
  --bg:#06110b; --bg2:#0a1a11; --txt:#eafff2; --muted:#a8c7b7;
  --line:rgba(255,255,255,.10); --live:#60a5fa; --good:#34d399; --ns:#a7f3d0;
  --shadow:0 18px 60px rgba(0,0,0,.45); --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--txt);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 520px at 18% -10%, rgba(34,197,94,.22), transparent 60%),
    radial-gradient(900px 520px at 80% -10%, rgba(96,165,250,.14), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
}
.wrap{max-width:1100px;margin:0 auto;padding:22px 16px 60px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#22c55e,#60a5fa);border:1px solid rgba(255,255,255,.10)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--txt);
  border-radius:999px;padding:10px 12px;font-weight:900;box-shadow:0 10px 28px rgba(0,0,0,.20);
}
.btn.primary{border-color:rgba(167,243,208,.35);background:rgba(167,243,208,.10)}
.pill{
  display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.04);
  border:1px solid var(--line);padding:10px 12px;border-radius:999px;
}
.pill input{background:transparent;border:0;outline:0;color:var(--txt);width:min(280px,56vw);font-weight:800}

.tabs{
  display:flex;gap:10px;background:rgba(255,255,255,.03);border:1px solid var(--line);
  border-radius:var(--radius);padding:10px;margin:14px 0;box-shadow:var(--shadow);
  overflow:auto;
}
.tab{
  padding:10px 12px;border-radius:999px;color:var(--muted);font-weight:950;cursor:pointer;
  border:1px solid transparent; background:transparent; white-space:nowrap;
}
.tab[aria-selected="true"]{color:var(--txt);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}

.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
@media(max-width:920px){.grid{grid-template-columns:1fr}}
.panel{
  background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:var(--radius);
  padding:14px;box-shadow:var(--shadow)
}
.panel h2{margin:0 0 10px;color:var(--muted);font-size:14px;text-transform:uppercase;letter-spacing:.3px}
.list{display:flex;flex-direction:column;gap:12px}

/* MATCH CARD */
.match{
  display:grid;grid-template-columns:170px 1fr 130px;gap:12px;align-items:center;
  padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.07);
  background:linear-gradient(180deg,rgba(13,35,23,.90),rgba(11,28,19,.72));
  position:relative; overflow:hidden;
}
.match:after{
  content:""; position:absolute; inset:-2px; pointer-events:none; opacity:.75;
  background:
    radial-gradient(520px 180px at 18% 18%, rgba(34,197,94,.18), transparent 60%),
    radial-gradient(520px 180px at 85% 10%, rgba(96,165,250,.12), transparent 60%);
}
.match > *{position:relative; z-index:1}
@media(max-width:560px){.match{grid-template-columns:120px 1fr 96px}}

.meta{display:flex;flex-direction:column;gap:10px}
.time{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);font-weight:900}
.kickoff{color:var(--txt)}
.badge{
  padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);font-weight:950; letter-spacing:.2px; display:inline-flex; gap:6px; align-items:center;
}
.badge.live{color:var(--live);border-color:rgba(96,165,250,.55);background:rgba(96,165,250,.10)}
.badge.ft{color:var(--good);border-color:rgba(52,211,153,.45);background:rgba(52,211,153,.10)}
.badge.ns{color:var(--ns);border-color:rgba(167,243,208,.40);background:rgba(167,243,208,.10)}
.minute{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:950}

@keyframes dotBlink{0%,49%{opacity:1}50%,100%{opacity:.25}}
.liveDot{width:7px;height:7px;border-radius:999px;background:var(--live);animation:dotBlink 1.2s linear infinite;box-shadow:0 0 12px rgba(96,165,250,.55)}

/* BROADCAST CENTER */
.broadcast{
  display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;
  padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.16)
}
.side{display:flex;align-items:center;gap:12px;min-width:0}
.side.right{justify-content:flex-end}
.logoBig{
  width:52px;height:52px;border-radius:16px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);object-fit:contain;box-shadow:0 12px 30px rgba(0,0,0,.22)
}
.name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
@media(max-width:560px){.logoBig{width:42px;height:42px}.name{max-width:150px}}

/* SCORE CENTER + SUBLINE */
.scoreWrap{display:flex;flex-direction:column;align-items:center;gap:6px}
.scoreCenter{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:10px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);box-shadow:0 10px 26px rgba(0,0,0,.25);
  min-width:120px;
}
.scoreCenter .n{font-size:26px;font-weight:1000;line-height:1;font-variant-numeric:tabular-nums}
.scoreCenter .dash{opacity:.6}
.scoreCenter .vs{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:.8px}
.subline{
  font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.3px;
  padding:5px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12);
}
@keyframes scoreFlip{0%{transform:translateY(0) scale(1);opacity:1}40%{transform:translateY(-4px) scale(1.02)}100%{transform:translateY(0) scale(1);opacity:1}}
.scoreFlip{animation:scoreFlip .35s ease-out}

/* RIGHT ACTIONS */
.actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.mini{
  padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);color:var(--txt);font-weight:950;cursor:pointer
}

.kv{display:flex;justify-content:space-between;padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.07);background:rgba(13,35,23,.55)}
.k{color:var(--muted);font-size:12px;font-weight:950}
.v{font-weight:1000}
.small{color:var(--muted);font-size:12px;line-height:1.45;margin-top:10px}
footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
.empty{
  padding:16px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);color:var(--muted);text-align:center
}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div style="font-weight:1000;letter-spacing:.2px">Marcadores ‚Äî Pro TV</div>
        <div style="color:var(--muted);font-size:12px">Conectado a API-Football (API-Sports)</div>
      </div>
    </div>

    <div class="controls">
      <div class="pill" title="Buscar equipo">
        üîé <input id="search" placeholder="Buscar: City, Madrid, PSG‚Ä¶" autocomplete="off"/>
      </div>
      <button class="btn" id="modeBtn" title="Cambia entre LIVE y HOY">Modo: HOY</button>
      <button class="btn primary" id="refreshBtn">‚Üª Actualizar</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Ligas">
    <button class="tab" role="tab" aria-selected="true" data-league="EPL">Premier League</button>
    <button class="tab" role="tab" aria-selected="false" data-league="LL">LaLiga</button>
    <button class="tab" role="tab" aria-selected="false" data-league="L1">Ligue 1</button>
  </nav>

  <div class="grid">
    <section class="panel">
      <h2 id="leagueTitle">Premier League ‚Äî Resultados</h2>
      <div id="matches" class="list"></div>
    </section>

    <aside class="panel">
      <h2>Resumen</h2>
      <div class="kv"><div class="k">Liga activa</div><div class="v" id="activeLeague">Premier League</div></div>
      <div class="kv"><div class="k">Partidos</div><div class="v" id="count">0</div></div>
      <div class="kv"><div class="k">LIVE</div><div class="v" id="liveCount">0</div></div>
      <div class="kv"><div class="k">FT</div><div class="v" id="ftCount">0</div></div>
      <div class="kv"><div class="k">√öltima</div><div class="v" id="updated">‚Äî</div></div>
      <div class="small" id="note">
        Si no te aparecen partidos, puede ser porque hoy no hay juegos en esa liga. Prueba ‚ÄúModo: LIVE‚Äù.
      </div>
    </aside>
  </div>

  <footer>Vista PRO TV ‚Äî banner √∫nico, sin info duplicada</footer>
</div>

<script>
/* ===== League IDs (API-Football) ===== */
const LEAGUES = {
  EPL: { name: "Premier League", id: 39 },
  LL:  { name: "LaLiga", id: 140 },
  L1:  { name: "Ligue 1", id: 61 }
};

/* ===== State ===== */
let active = "EPL";
let query = "";
let mode = "today"; // today | live
let lastScores = new Map(); // fixtureId -> "h-a"

/* ===== DOM ===== */
const elMatches = document.getElementById("matches");
const elTitle = document.getElementById("leagueTitle");
const elActive = document.getElementById("activeLeague");
const elCount = document.getElementById("count");
const elLive = document.getElementById("liveCount");
const elFt = document.getElementById("ftCount");
const elUpdated = document.getElementById("updated");
const elNote = document.getElementById("note");

/* ===== Helpers ===== */
function normalizeStatus(short){
  // API uses many short codes: NS, FT, HT, 1H, 2H, ET, PEN, etc.
  if (!short) return "NS";
  if (short === "FT" || short === "AET" || short === "PEN") return "FT";
  if (short === "NS") return "NS";
  // anything else = treat as LIVE for our UI (HT, 1H, 2H, ET, etc.)
  return "LIVE";
}
function periodFromShort(short){
  if (!short) return "";
  if (short === "1H") return "1T";
  if (short === "2H") return "2T";
  if (short === "HT") return "DESCANSO";
  if (short === "ET") return "TE";
  if (short === "PEN") return "PENALES";
  if (short === "FT" || short === "AET") return "FINAL";
  if (short === "NS") return "PR√ìXIMO";
  return "EN JUEGO";
}
function badge(status){
  if(status === "LIVE") return `<span class="badge live"><span class="liveDot"></span>LIVE</span>`;
  if(status === "FT") return `<span class="badge ft">FT</span>`;
  return `<span class="badge ns">NS</span>`;
}
function sublineText(m){
  if(m.status === "LIVE"){
    const add = (typeof m.added === "number") ? ` ¬∑ +${m.added}` : "";
    return `${m.period || "EN JUEGO"}${add}`;
  }
  if(m.status === "FT") return "FINAL";
  return "PR√ìXIMO";
}
function scoreHTML(m){
  if(m.status === "NS") return `<div class="scoreCenter"><div class="vs">VS</div></div>`;
  return `<div class="scoreCenter" data-scorebox="${m.id}">
            <div class="n">${m.h ?? 0}</div><div class="dash">‚Äì</div><div class="n">${m.a ?? 0}</div>
          </div>`;
}
function logoImg(src, alt){
  const fallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='14' ry='14' fill='rgba(255,255,255,0.08)'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='30'%3E%E2%9A%BD%3C/text%3E%3C/svg%3E";
  return `<img class="logoBig" src="${src || fallback}" alt="${alt}" loading="lazy"
    onerror="this.onerror=null;this.src='${fallback}'">`;
}

/* ===== API Load via Netlify Function ===== */
async function loadFromAPI(leagueId){
  // season: usa la actual (ajusta si quieres)
  const season = new Date().getFullYear(); // 2025 etc.
  const url = `/.netlify/functions/football?league=${leagueId}&season=${season}&mode=${mode}`;

  const res = await fetch(url);
  const json = await res.json();

  const fixtures = (json && json.response) ? json.response : [];

  return fixtures.map(f => {
    const short = f.fixture?.status?.short;
    const status = normalizeStatus(short);
    const elapsed = f.fixture?.status?.elapsed;
    const added = f.fixture?.status?.extra;

    return {
      id: String(f.fixture?.id),
      time: f.fixture?.date ? new Date(f.fixture.date).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"}) : "--:--",
      status,
      minute: (status === "LIVE" && typeof elapsed === "number") ? `${elapsed}'` : "",
      period: periodFromShort(short),
      added: (status === "LIVE" && typeof added === "number") ? added : undefined,
      home: f.teams?.home?.name || "Home",
      away: f.teams?.away?.name || "Away",
      homeLogo: f.teams?.home?.logo || "",
      awayLogo: f.teams?.away?.logo || "",
      h: f.goals?.home,
      a: f.goals?.away
    };
  });
}

/* ===== Render ===== */
function card(m){
  return `
  <article class="match" data-match="${m.id}">
    <div class="meta">
      <div class="time">
        <span class="kickoff">${m.time}</span>
        ${badge(m.status)}
        ${m.status==="LIVE" ? `<span class="minute">${m.minute || ""}</span>` : ``}
      </div>
    </div>

    <div class="broadcast">
      <div class="side">
        ${logoImg(m.homeLogo, m.home + " logo")}
        <div class="name" title="${m.home}">${m.home}</div>
      </div>

      <div class="scoreWrap">
        ${scoreHTML(m)}
        <div class="subline">${sublineText(m)}</div>
      </div>

      <div class="side right">
        <div class="name" title="${m.away}" style="text-align:right">${m.away}</div>
        ${logoImg(m.awayLogo, m.away + " logo")}
      </div>
    </div>

    <div class="actions">
      <button class="mini" data-action="details">Detalles</button>
      <button class="mini" data-action="follow">Seguir</button>
    </div>
  </article>`;
}

function animateScore(fixtureId){
  const box = document.querySelector(`[data-scorebox="${fixtureId}"]`);
  if(!box) return;
  box.classList.remove("scoreFlip");
  void box.offsetWidth;
  box.classList.add("scoreFlip");
}

let currentData = [];

function applySearch(arr){
  if(!query) return arr;
  const q = query.toLowerCase();
  return arr.filter(m => (m.home.toLowerCase().includes(q) || m.away.toLowerCase().includes(q)));
}

function render(arr){
  const meta = LEAGUES[active];
  const filtered = applySearch(arr);

  elTitle.textContent = `${meta.name} ‚Äî Resultados`;
  elActive.textContent = meta.name;

  elCount.textContent = String(filtered.length);
  elLive.textContent = String(filtered.filter(x=>x.status==="LIVE").length);
  elFt.textContent = String(filtered.filter(x=>x.status==="FT").length);
  elUpdated.textContent = new Date().toLocaleString("es-MX",{hour:"2-digit",minute:"2-digit"});

  if(filtered.length === 0){
    elMatches.innerHTML = `<div class="empty">No hay partidos para mostrar. Prueba ‚ÄúModo: LIVE‚Äù o cambia de liga.</div>`;
    return;
  }
  elMatches.innerHTML = filtered.map(card).join("");

  // bind buttons
  elMatches.querySelectorAll(".mini").forEach(b=>{
    b.addEventListener("click",(e)=>{
      const a=e.currentTarget.dataset.action;
      if(a==="details") alert("Demo: aqu√≠ abrir√≠amos eventos, alineaciones, etc.");
      if(a==="follow") alert("Demo: seguimiento/notificaciones.");
    });
  });
}

async function refresh(){
  const meta = LEAGUES[active];
  elNote.textContent = `Cargando ${meta.name} (${mode.toUpperCase()})‚Ä¶`;

  try{
    const data = await loadFromAPI(meta.id);
    // Animar si cambi√≥ el score
    data.forEach(m=>{
      if(m.status !== "NS" && typeof m.h === "number" && typeof m.a === "number"){
        const key = `${m.h}-${m.a}`;
        const prev = lastScores.get(m.id);
        if(prev && prev !== key){
          // marcar para animaci√≥n despu√©s de render
          m._scoreChanged = true;
        }
        lastScores.set(m.id, key);
      }
    });

    currentData = data;
    render(currentData);

    // disparar animaciones score-changed
    data.filter(x=>x._scoreChanged).forEach(x=>animateScore(x.id));

    elNote.textContent = `OK: ${meta.name} (${mode.toUpperCase()}).`;
  }catch(err){
    elMatches.innerHTML = `<div class="empty">Error cargando API. Revisa que en Netlify exista APISPORTS_KEY y la function.</div>`;
    elNote.textContent = `Error: ${String(err)}`;
  }
}

/* ===== Tabs (ya funcionando) ===== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.setAttribute("aria-selected","false"));
    tab.setAttribute("aria-selected","true");
    active = tab.dataset.league;
    refresh();
  });
});

/* ===== Search ===== */
document.getElementById("search").addEventListener("input",(e)=>{
  query = e.target.value.trim();
  render(currentData);
});

/* ===== Mode toggle ===== */
document.getElementById("modeBtn").addEventListener("click", (e)=>{
  mode = (mode === "today") ? "live" : "today";
  e.currentTarget.textContent = `Modo: ${mode === "today" ? "HOY" : "LIVE"}`;
  refresh();
});

/* ===== Refresh ===== */
document.getElementById("refreshBtn").addEventListener("click", ()=> refresh());

/* Auto-refresh inteligente: solo cuando est√°s en LIVE */
setInterval(()=>{
  if(mode === "live") refresh();
}, 60000); // cada 60s

refresh();
</script>
</body>
</html>
