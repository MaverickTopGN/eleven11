<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marcadores ‚Äî Pro TV (Jornadas + Detalle)</title>
<style>
:root{
  --bg:#06110b; --bg2:#0a1a11; --txt:#eafff2; --muted:#a8c7b7;
  --line:rgba(255,255,255,.10); --live:#60a5fa; --good:#34d399; --ns:#a7f3d0;
  --shadow:0 18px 60px rgba(0,0,0,.45); --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--txt);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 520px at 18% -10%, rgba(34,197,94,.22), transparent 60%),
    radial-gradient(900px 520px at 80% -10%, rgba(96,165,250,.14), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
}
.wrap{max-width:1100px;margin:0 auto;padding:22px 16px 60px}
header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#22c55e,#60a5fa);border:1px solid rgba(255,255,255,.10)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.btn{
  cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--txt);
  border-radius:999px;padding:10px 12px;font-weight:900;box-shadow:0 10px 28px rgba(0,0,0,.20);
}
.btn.primary{border-color:rgba(167,243,208,.35);background:rgba(167,243,208,.10)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.select{
  appearance:none;
  padding-right:34px;
  background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,.55) 50%),
                    linear-gradient(135deg, rgba(255,255,255,.55) 50%, transparent 50%);
  background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
  background-size: 6px 6px, 6px 6px;
  background-repeat:no-repeat;
}
.pill{
  display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.04);
  border:1px solid var(--line);padding:10px 12px;border-radius:999px;
}
.pill input{background:transparent;border:0;outline:0;color:var(--txt);width:min(260px,52vw);font-weight:800}

.tabs{
  display:flex;gap:10px;background:rgba(255,255,255,.03);border:1px solid var(--line);
  border-radius:var(--radius);padding:10px;margin:14px 0;box-shadow:var(--shadow);
  overflow:auto;
}
.tab{
  padding:10px 12px;border-radius:999px;color:var(--muted);font-weight:950;cursor:pointer;
  border:1px solid transparent; background:transparent; white-space:nowrap;
}
.tab[aria-selected="true"]{color:var(--txt);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}

.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
@media(max-width:920px){.grid{grid-template-columns:1fr}}
.panel{
  background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:var(--radius);
  padding:14px;box-shadow:var(--shadow)
}
.panel h2{margin:0 0 10px;color:var(--muted);font-size:14px;text-transform:uppercase;letter-spacing:.3px}
.list{display:flex;flex-direction:column;gap:12px}

/* Day header */
.dayHeader{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.12);
  box-shadow: 0 10px 28px rgba(0,0,0,.18);
}
.dayHeader .left{display:flex; flex-direction:column; gap:2px;}
.dayHeader .title{font-weight:1000;}
.dayHeader .sub{color: var(--muted); font-size:12px; font-weight:900;}
.dayHeader .count{color: var(--muted); font-weight:900; font-size:12px;padding:6px 10px; border-radius:999px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);}

.match{
  display:grid;grid-template-columns:170px 1fr 130px;gap:12px;align-items:center;
  padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.07);
  background:linear-gradient(180deg,rgba(13,35,23,.90),rgba(11,28,19,.72));
  position:relative; overflow:hidden;
  cursor:pointer;
}
.match:hover{border-color: rgba(255,255,255,.14)}
.match:after{
  content:""; position:absolute; inset:-2px; pointer-events:none; opacity:.75;
  background:
    radial-gradient(520px 180px at 18% 18%, rgba(34,197,94,.18), transparent 60%),
    radial-gradient(520px 180px at 85% 10%, rgba(96,165,250,.12), transparent 60%);
}
.match > *{position:relative; z-index:1}
@media(max-width:560px){.match{grid-template-columns:120px 1fr 96px}}

.meta{display:flex;flex-direction:column;gap:10px}
.time{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);font-weight:900}
.kickoff{color:var(--txt)}
.badge{
  padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);font-weight:950; letter-spacing:.2px; display:inline-flex; gap:6px; align-items:center;
}
.badge.live{color:var(--live);border-color:rgba(96,165,250,.55);background:rgba(96,165,250,.10)}
.badge.ft{color:var(--good);border-color:rgba(52,211,153,.45);background:rgba(52,211,153,.10)}
.badge.ns{color:var(--ns);border-color:rgba(167,243,208,.40);background:rgba(167,243,208,.10)}
.minute{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:950}
@keyframes dotBlink{0%,49%{opacity:1}50%,100%{opacity:.25}}
.liveDot{width:7px;height:7px;border-radius:999px;background:var(--live);animation:dotBlink 1.2s linear infinite;box-shadow:0 0 12px rgba(96,165,250,.55)}

.broadcast{
  display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;
  padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.16)
}
.side{display:flex;align-items:center;gap:12px;min-width:0}
.side.right{justify-content:flex-end}
.logoBig{
  width:52px;height:52px;border-radius:16px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);object-fit:contain;box-shadow:0 12px 30px rgba(0,0,0,.22)
}
.name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
@media(max-width:560px){.logoBig{width:42px;height:42px}.name{max-width:150px}}

.scoreWrap{display:flex;flex-direction:column;align-items:center;gap:6px}
.scoreCenter{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:10px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);box-shadow:0 10px 26px rgba(0,0,0,.25);
  min-width:120px;
}
.scoreCenter .n{font-size:26px;font-weight:1000;line-height:1;font-variant-numeric:tabular-nums}
.scoreCenter .dash{opacity:.6}
.scoreCenter .vs{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:.8px}
.subline{
  font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.3px;
  padding:5px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12);
}
@keyframes scoreFlip{0%{transform:translateY(0) scale(1);opacity:1}40%{transform:translateY(-4px) scale(1.02)}100%{transform:translateY(0) scale(1);opacity:1}}
.scoreFlip{animation:scoreFlip .35s ease-out}

.actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.mini{
  padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);color:var(--txt);font-weight:950;cursor:pointer
}

.kv{display:flex;justify-content:space-between;padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.07);background:rgba(13,35,23,.55)}
.k{color:var(--muted);font-size:12px;font-weight:950}
.v{font-weight:1000}
.small{color:var(--muted);font-size:12px;line-height:1.45;margin-top:10px}
footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
.empty{padding:16px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);color:var(--muted);text-align:center}
.legend{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px}
.dot.past{background:rgba(255,255,255,.35)}
.dot.current{background:rgba(52,211,153,.75)}
.dot.future{background:rgba(96,165,250,.75)}

/* ==============================
   ‚úÖ MATCH DETAILS MODAL (iPhone)
   ============================== */
.modalOverlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding: 14px;
  z-index: 9999;
}
.modalOverlay.show{display:flex}
.modal{
  width:min(920px, 100%);
  max-height: 92vh;
  border-radius: 22px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(10,16,14,.96), rgba(6,10,8,.96));
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
}
.modalTop{
  position:relative;
  padding: 16px;
  background:
    radial-gradient(700px 320px at 18% 10%, rgba(239,68,68,.22), transparent 60%),
    radial-gradient(700px 320px at 85% 10%, rgba(96,165,250,.16), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  border-bottom:1px solid rgba(255,255,255,.08);
}
.modalHeaderRow{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
}
.pillMini{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--muted);
  font-weight:900;
  font-size:12px;
}
.closeBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--txt);
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 1000;
  cursor:pointer;
}
.modalScoreRow{
  margin-top: 14px;
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap: 14px;
}
.modalTeam{
  display:flex; gap:12px; align-items:center; min-width:0;
}
.modalTeam.right{justify-content:flex-end}
.modalTeam .tname{
  font-weight:1000;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.modalBigLogo{
  width:56px; height:56px;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  object-fit:contain;
}
.modalScore{
  display:flex; flex-direction:column; align-items:center; gap:6px;
}
.modalScore .big{
  font-weight:1100;
  font-variant-numeric: tabular-nums;
  font-size: 54px;
  line-height: 1;
  letter-spacing: .5px;
}
.modalScore .status{
  color: var(--muted);
  font-weight:900;
  font-size: 12px;
  letter-spacing:.3px;
}
.modalTabs{
  display:flex; gap:10px;
  padding: 12px 14px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.02);
  overflow:auto;
}
.modalTab{
  white-space:nowrap;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid transparent;
  background: transparent;
  color: var(--muted);
  font-weight: 1000;
  cursor:pointer;
}
.modalTab.active{
  color: var(--txt);
  border-color: rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
}
.modalBody{
  padding: 14px;
  max-height: calc(92vh - 220px);
  overflow:auto;
}
.cardBlock{
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px;
}
.row2{
  display:grid; grid-template-columns: 1fr 1fr; gap:10px;
}
@media(max-width:720px){ .row2{grid-template-columns:1fr} }

.eventRow{
  display:flex; justify-content:space-between; gap:12px;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.12);
}
.eventRow .left{
  display:flex; gap:10px; align-items:center; min-width:0;
}
.eventRow .min{
  font-weight:1000; color: var(--txt);
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  flex:0 0 auto;
}
.eventRow .desc{
  color: var(--muted);
  font-weight:900;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.statRow{
  display:grid;
  grid-template-columns: 1fr 52px 1fr;
  gap:10px;
  align-items:center;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.12);
}
.statRow .label{
  grid-column: 1 / -1;
  color: var(--muted);
  font-size:12px;
  font-weight:900;
  margin-bottom:6px;
}
.bar{
  height:10px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  overflow:hidden;
}
.bar > div{height:100%; width:50%}
.statNums{
  font-weight:1000;
  font-variant-numeric: tabular-nums;
  text-align:center;
  color: var(--txt);
}
.smallMuted{color:var(--muted); font-size:12px; font-weight:900}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div style="font-weight:1000;letter-spacing:.2px">Marcadores ‚Äî Pro TV</div>
        <div style="color:var(--muted);font-size:12px">Jornadas + d√≠as + detalle tipo app</div>
      </div>
    </div>

    <div class="controls">
      <div class="pill"><span>üîé</span><input id="search" placeholder="Buscar equipo‚Ä¶" /></div>

      <button class="btn" id="prevRound">‚¨Ö</button>
      <select class="btn select" id="roundSelect"></select>
      <button class="btn" id="nextRound">‚û°</button>

      <button class="btn" id="modeBtn">Modo: JORNADA</button>
      <button class="btn primary" id="refreshBtn">‚Üª Actualizar</button>
    </div>

    <div class="legend" style="width:100%;margin-top:10px">
      <span><span class="dot past"></span>Pasada</span>
      <span><span class="dot current"></span>Actual</span>
      <span><span class="dot future"></span>Futura</span>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Ligas">
    <button class="tab" role="tab" aria-selected="true" data-league="EPL">Premier League</button>
    <button class="tab" role="tab" aria-selected="false" data-league="LL">LaLiga</button>
    <button class="tab" role="tab" aria-selected="false" data-league="L1">Ligue 1</button>
  </nav>

  <div class="grid">
    <section class="panel">
      <h2 id="leagueTitle">Premier League ‚Äî Jornada</h2>
      <div id="matches" class="list"></div>
    </section>

    <aside class="panel">
      <h2>Resumen</h2>
      <div class="kv"><div class="k">Liga activa</div><div class="v" id="activeLeague">Premier League</div></div>
      <div class="kv"><div class="k">Modo</div><div class="v" id="modeLabel">JORNADA</div></div>
      <div class="kv"><div class="k">Jornada</div><div class="v" id="roundLabel">‚Äî</div></div>
      <div class="kv"><div class="k">Partidos</div><div class="v" id="count">0</div></div>
      <div class="kv"><div class="k">LIVE</div><div class="v" id="liveCount">0</div></div>
      <div class="kv"><div class="k">FT</div><div class="v" id="ftCount">0</div></div>
      <div class="kv"><div class="k">√öltima</div><div class="v" id="updated">‚Äî</div></div>
      <div class="small" id="note">Cargando jornadas‚Ä¶</div>
    </aside>
  </div>

  <footer>Pro TV ‚Äî clic en partido abre detalle tipo app</footer>
</div>

<!-- ‚úÖ MODAL -->
<div class="modalOverlay" id="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Detalle del partido">
    <div class="modalTop">
      <div class="modalHeaderRow">
        <div class="pillMini" id="modalLeague">Liga</div>
        <button class="closeBtn" id="closeModal">‚úï</button>
      </div>

      <div class="modalScoreRow">
        <div class="modalTeam" id="modalHome"></div>
        <div class="modalScore">
          <div class="big" id="modalScore">‚Äî</div>
          <div class="status" id="modalStatus">‚Äî</div>
        </div>
        <div class="modalTeam right" id="modalAway"></div>
      </div>
    </div>

    <div class="modalTabs">
      <button class="modalTab active" data-tab="stats">Stats</button>
      <button class="modalTab" data-tab="events">Play-by-Play</button>
      <button class="modalTab" data-tab="standings">Standings</button>
    </div>

    <div class="modalBody">
      <div id="tab_stats" class="cardBlock"></div>
      <div id="tab_events" class="cardBlock" style="display:none"></div>
      <div id="tab_standings" class="cardBlock" style="display:none"></div>
    </div>
  </div>
</div>

<script>
const LEAGUES = {
  EPL: { name:"Premier League", id:39 },
  LL:  { name:"LaLiga", id:140 },
  L1:  { name:"Ligue 1", id:61 }
};

// Temporada auto (EU)
function getCurrentSeason(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;
  return (m >= 7) ? y : (y - 1);
}
const SEASON = getCurrentSeason();
const TZ = "America/Mexico_City";

let active = "EPL";
let mode = "round"; // round | live
let query = "";
let currentData = [];
let rounds = [];
let roundIndex = 0;
let roundsCache = new Map();
let currentRoundCache = new Map();
let lastScores = new Map();

// Modal state
let selectedMatch = null; // match object

const elMatches = document.getElementById("matches");
const elTitle = document.getElementById("leagueTitle");
const elActive = document.getElementById("activeLeague");
const elCount = document.getElementById("count");
const elLive = document.getElementById("liveCount");
const elFt = document.getElementById("ftCount");
const elUpdated = document.getElementById("updated");
const elModeLabel = document.getElementById("modeLabel");
const elRoundLabel = document.getElementById("roundLabel");
const elNote = document.getElementById("note");

const roundSelect = document.getElementById("roundSelect");
const prevRoundBtn = document.getElementById("prevRound");
const nextRoundBtn = document.getElementById("nextRound");
const modeBtn = document.getElementById("modeBtn");
const refreshBtn = document.getElementById("refreshBtn");

function normalizeStatus(short){
  if (!short) return "NS";
  if (short === "FT" || short === "AET" || short === "PEN") return "FT";
  if (short === "NS") return "NS";
  return "LIVE";
}
function periodFromShort(short){
  if (!short) return "";
  if (short === "1H") return "1T";
  if (short === "2H") return "2T";
  if (short === "HT") return "DESCANSO";
  if (short === "ET") return "TE";
  if (short === "PEN") return "PENALES";
  if (short === "FT" || short === "AET") return "FINAL";
  if (short === "NS") return "PR√ìXIMO";
  return "EN JUEGO";
}
function badge(status){
  if(status === "LIVE") return `<span class="badge live"><span class="liveDot"></span>LIVE</span>`;
  if(status === "FT") return `<span class="badge ft">FT</span>`;
  return `<span class="badge ns">NS</span>`;
}
function sublineText(m){
  if(m.status === "LIVE"){
    const add = (typeof m.added === "number") ? ` ¬∑ +${m.added}` : "";
    return `${m.period || "EN JUEGO"}${add}`;
  }
  if(m.status === "FT") return "FINAL";
  return "PR√ìXIMO";
}
function scoreHTML(m){
  if(m.status === "NS") return `<div class="scoreCenter"><div class="vs">VS</div></div>`;
  return `<div class="scoreCenter" data-scorebox="${m.id}">
            <div class="n">${m.h ?? 0}</div><div class="dash">‚Äì</div><div class="n">${m.a ?? 0}</div>
          </div>`;
}
function logoImg(src, alt){
  const fallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='14' ry='14' fill='rgba(255,255,255,0.08)'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='30'%3E%E2%9A%BD%3C/text%3E%3C/svg%3E";
  return `<img class="logoBig" src="${src || fallback}" alt="${alt}" loading="lazy"
    onerror="this.onerror=null;this.src='${fallback}'">`;
}
function animateScore(fixtureId){
  const box = document.querySelector(`[data-scorebox="${fixtureId}"]`);
  if(!box) return;
  box.classList.remove("scoreFlip");
  void box.offsetWidth;
  box.classList.add("scoreFlip");
}

function mapFixtures(json){
  const fixtures = (json && json.response) ? json.response : [];
  return fixtures.map(f => {
    const short = f.fixture?.status?.short;
    const status = normalizeStatus(short);
    const elapsed = f.fixture?.status?.elapsed;
    const added = f.fixture?.status?.extra;

    const dateISO = f.fixture?.date || null;

    // Guardamos IDs importantes para futuro (stats/events/standings)
    const fixtureId = f.fixture?.id;
    const leagueId = f.league?.id;
    const leagueName = f.league?.name || "";
    const homeId = f.teams?.home?.id;
    const awayId = f.teams?.away?.id;

    return {
      id: String(fixtureId),
      fixtureId,
      leagueId,
      leagueName,
      dateISO,
      time: dateISO ? new Date(dateISO).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"}) : "--:--",
      status,
      minute: (status === "LIVE" && typeof elapsed === "number") ? `${elapsed}'` : "",
      period: periodFromShort(short),
      added: (status === "LIVE" && typeof added === "number") ? added : undefined,
      home: f.teams?.home?.name || "Home",
      away: f.teams?.away?.name || "Away",
      homeId,
      awayId,
      homeLogo: f.teams?.home?.logo || "",
      awayLogo: f.teams?.away?.logo || "",
      h: f.goals?.home,
      a: f.goals?.away
    };
  });
}

async function api(endpoint, params){
  const u = new URL("/.netlify/functions/football", location.origin);
  u.searchParams.set("endpoint", endpoint);
  u.searchParams.set("timezone", TZ);
  Object.entries(params).forEach(([k,v])=>{
    if (v !== undefined && v !== null && v !== "") u.searchParams.set(k, String(v));
  });
  const res = await fetch(u.toString());
  return res.json();
}

// -------- Jornada actual para etiquetar --------
const FINISHED = new Set(["FT","AET","PEN"]);
function isRoundFinished(fixturesRaw){
  if (!fixturesRaw.length) return false;
  return fixturesRaw.every(f => FINISHED.has(f.fixture?.status?.short));
}
async function getRoundsRaw(leagueKey){
  if (roundsCache.has(leagueKey)) return roundsCache.get(leagueKey);
  const meta = LEAGUES[leagueKey];
  const j = await api("rounds", { league: meta.id, season: SEASON });
  const arr = j.response || [];
  roundsCache.set(leagueKey, arr);
  return arr;
}
async function fetchFixturesRawByRound(leagueKey, round){
  const meta = LEAGUES[leagueKey];
  const j = await api("fixtures", { league: meta.id, season: SEASON, round });
  return j.response || [];
}
async function detectCurrentRound(leagueKey){
  if (currentRoundCache.has(leagueKey)) return currentRoundCache.get(leagueKey);

  const roundsRaw = await getRoundsRaw(leagueKey);
  if (!roundsRaw.length) return null;

  let lo = 0, hi = roundsRaw.length - 1, ans = null;
  while (lo <= hi) {
    const mid = Math.floor((lo + hi) / 2);
    const round = roundsRaw[mid];
    const fixturesRaw = await fetchFixturesRawByRound(leagueKey, round);
    const finished = isRoundFinished(fixturesRaw);
    if (finished) lo = mid + 1;
    else { ans = round; hi = mid - 1; }
  }

  if (!ans) ans = roundsRaw[roundsRaw.length - 1];
  currentRoundCache.set(leagueKey, ans);
  return ans;
}

// -------- UI Jornadas --------
function roundPretty(roundStr){
  return roundStr.replace("Regular Season -", "Jornada").trim();
}
function statusEmoji(status){
  if (status === "current") return "üü¢";
  if (status === "future") return "üîµ";
  return "‚ö´";
}
function renderRoundSelector(){
  roundSelect.innerHTML = "";
  rounds.forEach((r, i) => {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${statusEmoji(r.status)} ${roundPretty(r.round)} (${r.status === "current" ? "Actual" : r.status === "past" ? "Pasada" : "Futura"})`;
    if (i === roundIndex) opt.selected = true;
    roundSelect.appendChild(opt);
  });
  prevRoundBtn.disabled = (roundIndex <= 0);
  nextRoundBtn.disabled = (roundIndex >= rounds.length - 1);
}

// -------- Agrupar por d√≠a --------
function dayKeyFromISO(iso){
  if (!iso) return "unknown";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).format(d);
}
function dayTitleFromKey(yyyy_mm_dd){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  const pretty = new Intl.DateTimeFormat("es-MX", { timeZone: TZ, weekday:"long", day:"numeric", month:"long" }).format(dt);
  return pretty.charAt(0).toUpperCase() + pretty.slice(1);
}
function groupByDay(arr){
  const map = new Map();
  arr.forEach(m=>{
    const key = dayKeyFromISO(m.dateISO);
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(m);
  });

  const keys = [...map.keys()].sort((a,b)=>{
    if (a === "unknown") return 1;
    if (b === "unknown") return -1;
    return a.localeCompare(b);
  });

  keys.forEach(k=>{
    map.get(k).sort((a,b)=>{
      const ta = a.dateISO ? new Date(a.dateISO).getTime() : 0;
      const tb = b.dateISO ? new Date(b.dateISO).getTime() : 0;
      return ta - tb;
    });
  });

  return keys.map(k=>({ dayKey:k, items: map.get(k) }));
}

// -------- Render partidos + click abre modal --------
function applySearch(arr){
  if(!query) return arr;
  const q = query.toLowerCase();
  return arr.filter(m => (m.home.toLowerCase().includes(q) || m.away.toLowerCase().includes(q)));
}
function card(m){
  return `
  <article class="match" data-fixture="${m.id}">
    <div class="meta">
      <div class="time">
        <span class="kickoff">${m.time}</span>
        ${badge(m.status)}
        ${m.status==="LIVE" ? `<span class="minute">${m.minute || ""}</span>` : ``}
      </div>
    </div>

    <div class="broadcast">
      <div class="side">
        ${logoImg(m.homeLogo, m.home + " logo")}
        <div class="name" title="${m.home}">${m.home}</div>
      </div>

      <div class="scoreWrap">
        ${scoreHTML(m)}
        <div class="subline">${sublineText(m)}</div>
      </div>

      <div class="side right">
        <div class="name" title="${m.away}" style="text-align:right">${m.away}</div>
        ${logoImg(m.awayLogo, m.away + " logo")}
      </div>
    </div>

    <div class="actions">
      <button class="mini" data-action="details">Detalles</button>
      <button class="mini" data-action="follow">Seguir</button>
    </div>
  </article>`;
}

function render(arr){
  const meta = LEAGUES[active];
  const filtered = applySearch(arr);

  elActive.textContent = meta.name;
  elModeLabel.textContent = (mode === "round") ? "JORNADA" : "LIVE";
  elTitle.textContent = `${meta.name} ‚Äî ${(mode === "round") ? "Jornada" : "En vivo"}`;

  elCount.textContent = String(filtered.length);
  elLive.textContent = String(filtered.filter(x=>x.status==="LIVE").length);
  elFt.textContent = String(filtered.filter(x=>x.status==="FT").length);
  elUpdated.textContent = new Date().toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});

  if(filtered.length === 0){
    elMatches.innerHTML = `<div class="empty">No hay partidos para mostrar.</div>`;
    return;
  }

  const grouped = groupByDay(filtered);

  elMatches.innerHTML = grouped.map(g=>{
    const title = g.dayKey === "unknown" ? "Sin fecha" : dayTitleFromKey(g.dayKey);
    return `
      <div class="dayHeader">
        <div class="left">
          <div class="title">${title}</div>
          <div class="sub">Partidos del d√≠a</div>
        </div>
        <div class="count">${g.items.length} partidos</div>
      </div>
      ${g.items.map(card).join("")}
    `;
  }).join("");

  // bind actions
  elMatches.querySelectorAll(".mini").forEach(b=>{
    b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const a=e.currentTarget.dataset.action;
      if(a==="details") alert("Demo: aqu√≠ abrimos el modal (clic en tarjeta).");
      if(a==="follow") alert("Demo: seguimiento/alertas.");
    });
  });

  // click en partido abre modal
  elMatches.querySelectorAll(".match").forEach(cardEl=>{
    cardEl.addEventListener("click", ()=>{
      const id = cardEl.getAttribute("data-fixture");
      const m = currentData.find(x => x.id === id);
      if (m) openMatchModal(m);
    });
  });

  // animaci√≥n score change
  filtered.forEach(m=>{
    if (m.status !== "NS" && typeof m.h === "number" && typeof m.a === "number") {
      const key = `${m.h}-${m.a}`;
      const prev = lastScores.get(m.id);
      if (prev && prev !== key) animateScore(m.id);
      lastScores.set(m.id, key);
    }
  });
}

// -------- Cargar jornada / refresh --------
async function loadRoundByIndex(idx){
  roundIndex = idx;
  renderRoundSelector();

  const meta = LEAGUES[active];
  const r = rounds[roundIndex];
  elRoundLabel.textContent = `${roundPretty(r.round)} (${r.status === "current" ? "Actual" : r.status === "past" ? "Pasada" : "Futura"})`;

  elNote.textContent = `Cargando ${roundPretty(r.round)}‚Ä¶`;
  const j = await api("fixtures", { league: meta.id, season: SEASON, round: r.round });
  currentData = mapFixtures(j);
  elNote.textContent = "OK.";
  render(currentData);
}

async function refresh(){
  const meta = LEAGUES[active];
  elNote.textContent = "Cargando‚Ä¶";

  if (mode === "live") {
    elRoundLabel.textContent = "‚Äî";
    const j = await api("fixtures", { league: meta.id, season: SEASON, live: "all" });
    currentData = mapFixtures(j);
    elNote.textContent = "OK: LIVE.";
    render(currentData);
    return;
  }

  const roundsRaw = await getRoundsRaw(active);
  const currentRound = await detectCurrentRound(active);

  const currentIdx = Math.max(0, roundsRaw.indexOf(currentRound));
  rounds = roundsRaw.map((round, idx) => ({
    round,
    index: idx,
    status: idx < currentIdx ? "past" : (idx === currentIdx ? "current" : "future")
  }));

  roundIndex = currentIdx;
  renderRoundSelector();
  await loadRoundByIndex(roundIndex);
}

// -------- Events UI --------
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.setAttribute("aria-selected","false"));
    tab.setAttribute("aria-selected","true");
    active = tab.dataset.league;
    await refresh();
  });
});

document.getElementById("search").addEventListener("input",(e)=>{
  query = e.target.value.trim();
  render(currentData);
});

roundSelect.addEventListener("change", e => loadRoundByIndex(Number(e.target.value)));
prevRoundBtn.addEventListener("click", ()=> { if (roundIndex > 0) loadRoundByIndex(roundIndex - 1); });
nextRoundBtn.addEventListener("click", ()=> { if (roundIndex < rounds.length - 1) loadRoundByIndex(roundIndex + 1); });

modeBtn.addEventListener("click", async ()=>{
  mode = (mode === "round") ? "live" : "round";
  modeBtn.textContent = `Modo: ${mode === "round" ? "JORNADA" : "LIVE"}`;
  await refresh();
});

refreshBtn.addEventListener("click", ()=> refresh());

setInterval(()=>{ if (mode === "live") refresh(); }, 60000);

/* =========================================
   ‚úÖ MODAL: dise√±o tipo app (demo data)
   Luego conectamos eventos/stats reales.
   ========================================= */
const modalOverlay = document.getElementById("modalOverlay");
const closeModalBtn = document.getElementById("closeModal");
const modalLeague = document.getElementById("modalLeague");
const modalHome = document.getElementById("modalHome");
const modalAway = document.getElementById("modalAway");
const modalScore = document.getElementById("modalScore");
const modalStatus = document.getElementById("modalStatus");

const tabStats = document.getElementById("tab_stats");
const tabEvents = document.getElementById("tab_events");
const tabStandings = document.getElementById("tab_standings");

function openMatchModal(match){
  selectedMatch = match;
  modalOverlay.classList.add("show");
  document.body.style.overflow = "hidden";

  // Header
  modalLeague.textContent = match.leagueName || LEAGUES[active].name;
  modalHome.innerHTML = `${logoImg(match.homeLogo, match.home)}<div class="tname">${match.home}</div>`;
  modalAway.innerHTML = `<div class="tname">${match.away}</div>${logoImg(match.awayLogo, match.away)}`;

  const scoreText = (match.status === "NS") ? "‚Äî" : `${match.h ?? 0} - ${match.a ?? 0}`;
  modalScore.textContent = scoreText;
  modalStatus.textContent =
    (match.status === "FT") ? "Final" :
    (match.status === "LIVE") ? `En juego ${match.minute || ""}` :
    "Pr√≥ximo";

  // Tabs (por ahora DEMO)
  renderModalStats(match);
  renderModalEvents(match);
  renderModalStandings(match);

  setActiveModalTab("stats");
}

function closeMatchModal(){
  modalOverlay.classList.remove("show");
  document.body.style.overflow = "";
  selectedMatch = null;
}

closeModalBtn.addEventListener("click", closeMatchModal);
modalOverlay.addEventListener("click", (e)=>{
  if (e.target === modalOverlay) closeMatchModal();
});
document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeMatchModal();
});

document.querySelectorAll(".modalTab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    setActiveModalTab(btn.dataset.tab);
  });
});

function setActiveModalTab(key){
  document.querySelectorAll(".modalTab").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.modalTab[data-tab="${key}"]`).classList.add("active");

  tabStats.style.display = (key === "stats") ? "block" : "none";
  tabEvents.style.display = (key === "events") ? "block" : "none";
  tabStandings.style.display = (key === "standings") ? "block" : "none";
}

// ====== Demo ‚ÄúStats‚Äù (barras) ======
function statBarRow(label, homeVal, awayVal){
  const total = (homeVal + awayVal) || 1;
  const homePct = Math.round((homeVal / total) * 100);
  const awayPct = 100 - homePct;

  return `
    <div class="statRow">
      <div class="label">${label}</div>
      <div class="smallMuted" style="text-align:left;font-weight:1000">${homeVal}</div>
      <div class="statNums">${awayVal}</div>

      <div class="bar" style="grid-column:1 / span 1"><div style="width:${homePct}%; background: rgba(239,68,68,.75)"></div></div>
      <div></div>
      <div class="bar" style="grid-column:3 / span 1"><div style="width:${awayPct}%; background: rgba(96,165,250,.75)"></div></div>
    </div>
  `;
}

function renderModalStats(match){
  // ‚ö†Ô∏è Demo: valores inventados (luego conectamos /fixtures/statistics)
  const demo = {
    Possession: [55,45],
    Shots: [14,12],
    "Shots on Goal": [6,5],
    Corners: [7,3],
    Fouls: [11,14],
    "Yellow Cards": [2,3]
  };

  tabStats.innerHTML = `
    <div class="row2">
      <div class="cardBlock">
        <div style="font-weight:1000;margin-bottom:8px">Team Stats</div>
        ${statBarRow("Posesi√≥n %", demo.Possession[0], demo.Possession[1])}
        ${statBarRow("Tiros", demo.Shots[0], demo.Shots[1])}
        ${statBarRow("Tiros a puerta", demo["Shots on Goal"][0], demo["Shots on Goal"][1])}
        ${statBarRow("Corners", demo.Corners[0], demo.Corners[1])}
        ${statBarRow("Faltas", demo.Fouls[0], demo.Fouls[1])}
        ${statBarRow("Amarillas", demo["Yellow Cards"][0], demo["Yellow Cards"][1])}
        <div class="smallMuted" style="margin-top:10px">* Demo visual. Luego lo conectamos a stats reales.</div>
      </div>
      <div class="cardBlock">
        <div style="font-weight:1000;margin-bottom:8px">Info</div>
        <div class="smallMuted">Fecha: ${match.dateISO ? new Date(match.dateISO).toLocaleString("es-MX",{timeZone:TZ, weekday:"long", day:"numeric", month:"long", hour:"2-digit", minute:"2-digit"}) : "‚Äî"}</div>
        <div class="smallMuted" style="margin-top:8px">Liga: ${match.leagueName || "‚Äî"}</div>
        <div class="smallMuted" style="margin-top:8px">Fixture ID: ${match.fixtureId || match.id}</div>
        <div class="smallMuted" style="margin-top:8px">Siguiente paso: traer eventos y estad√≠sticas reales desde la API.</div>
      </div>
    </div>
  `;
}

// ====== Demo ‚ÄúEvents‚Äù ======
function renderModalEvents(match){
  // ‚ö†Ô∏è Demo: inventado. Luego conectamos /fixtures/events?fixture=ID
  const demoEvents = [
    { min:"13'", txt:`Gol ${match.home}`},
    { min:"40'", txt:`Gol ${match.away}`},
    { min:"77'", txt:`Tarjeta ${match.home}`},
    { min:"84'", txt:`Gol ${match.away}`}
  ];

  tabEvents.innerHTML = `
    <div style="font-weight:1000;margin-bottom:10px">Play-by-Play</div>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${demoEvents.map(e=>`
        <div class="eventRow">
          <div class="left">
            <div class="min">${e.min}</div>
            <div class="desc">${e.txt}</div>
          </div>
          <div class="smallMuted">Demo</div>
        </div>
      `).join("")}
    </div>
    <div class="smallMuted" style="margin-top:10px">* Luego lo conectamos a eventos reales del fixture.</div>
  `;
}

// ====== Demo ‚ÄúStandings‚Äù ======
function renderModalStandings(match){
  tabStandings.innerHTML = `
    <div style="font-weight:1000;margin-bottom:10px">Standings</div>
    <div class="smallMuted">Aqu√≠ mostraremos la tabla real de la liga (API: standings) y resaltaremos estos equipos.</div>
    <div class="smallMuted" style="margin-top:10px">* Demo por ahora.</div>
  `;
}

// start
refresh();
</script>
</body>
</html>
