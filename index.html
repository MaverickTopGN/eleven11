<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marcadores ‚Äî Pro TV</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#06110b; --bg2:#0a1a11; --txt:#eafff2; --muted:#a8c7b7;
  --line:rgba(255,255,255,.10); --live:#60a5fa; --good:#34d399; --ns:#a7f3d0;
  --shadow:0 18px 60px rgba(0,0,0,.45); --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--txt);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  letter-spacing:-0.01em;
  background:
    radial-gradient(900px 520px at 18% -10%, rgba(34,197,94,.20), transparent 60%),
    radial-gradient(900px 520px at 80% -10%, rgba(96,165,250,.12), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
}

.wrap{max-width:1100px;margin:0 auto;padding:22px 16px 60px}
header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,#22c55e,#60a5fa);border:1px solid rgba(255,255,255,.10)}
.brandTitle .h{font-weight:900;font-size:16px;line-height:1.15}
.brandTitle .p{color:var(--muted);font-size:12px;font-weight:600}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.btn{
  cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--txt);
  border-radius:999px;padding:9px 12px;font-weight:800;font-size:13px;
  box-shadow:0 10px 28px rgba(0,0,0,.18);
}
.btn.primary{border-color:rgba(167,243,208,.35);background:rgba(167,243,208,.10)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.select{
  appearance:none;
  padding-right:34px;
  background-image:linear-gradient(45deg,transparent 50%,rgba(255,255,255,.55) 50%),linear-gradient(135deg,rgba(255,255,255,.55) 50%,transparent 50%);
  background-position:calc(100% - 18px) calc(50% - 3px),calc(100% - 12px) calc(50% - 3px);
  background-size:6px 6px,6px 6px;background-repeat:no-repeat
}
.pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.04);border:1px solid var(--line);padding:9px 12px;border-radius:999px}
.pill input{background:transparent;border:0;outline:0;color:var(--txt);width:min(260px,52vw);font-weight:700;font-size:13px}

.legend{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;font-weight:700;width:100%;margin-top:10px}
.dot{display:inline-block;width:9px;height:9px;border-radius:999px;margin-right:6px}
.dot.past{background:rgba(255,255,255,.35)}
.dot.current{background:rgba(52,211,153,.78)}
.dot.future{background:rgba(96,165,250,.75)}

.tabs{display:flex;gap:10px;background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:var(--radius);padding:10px;margin:14px 0;box-shadow:var(--shadow);overflow:auto}
.tab{padding:10px 12px;border-radius:999px;color:var(--muted);font-weight:900;font-size:13px;cursor:pointer;border:1px solid transparent;background:transparent;white-space:nowrap}
.tab[aria-selected="true"]{color:var(--txt);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}

.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
@media(max-width:920px){.grid{grid-template-columns:1fr}}
.panel{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
.panel h2{margin:0 0 10px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.14em;font-weight:900}
.list{display:flex;flex-direction:column;gap:12px}

/* Day header */
.dayHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12)}
.dayHeader .title{font-weight:900;font-size:14px}
.dayHeader .sub{color:var(--muted);font-size:12px;font-weight:700}
.dayHeader .count{color:var(--muted);font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}

/* Match card */
.match{display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.07);background:linear-gradient(180deg,rgba(13,35,23,.90),rgba(11,28,19,.72));position:relative;overflow:hidden;cursor:pointer}
@media(max-width:560px){.match{grid-template-columns:110px 1fr}}
.time{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);font-weight:800}
.kickoff{color:var(--txt);font-weight:900}
.badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:900;font-size:11px;display:inline-flex;gap:6px;align-items:center}
.badge.ns{color:var(--ns);border-color:rgba(167,243,208,.40);background:rgba(167,243,208,.10)}
.badge.ft{color:var(--good);border-color:rgba(52,211,153,.45);background:rgba(52,211,153,.10)}
.badge.live{color:var(--live);border-color:rgba(96,165,250,.55);background:rgba(96,165,250,.10)}
.minute{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:900;font-size:11px}

.broadcast{display:grid;grid-template-columns:auto 86px auto;align-items:center;gap:10px;padding:10px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.14)}
.logoBig{width:50px;height:50px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);object-fit:contain}
.scoreWrap{display:flex;flex-direction:column;align-items:center;gap:6px}
.scoreCenter{display:flex;align-items:center;justify-content:center;gap:6px;padding:7px 9px;border-radius:11px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);min-width:74px}
.scoreCenter .n{font-size:18px;font-weight:900;line-height:1;font-variant-numeric:tabular-nums}
.scoreCenter .dash{opacity:.55}
.scoreCenter .vs{font-size:9.5px;color:var(--muted);font-weight:900;letter-spacing:.14em;text-transform:uppercase}
.subline{font-size:9.5px;color:var(--muted);font-weight:800;letter-spacing:.08em;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12);text-transform:uppercase}

.kv{display:flex;justify-content:space-between;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.07);background:rgba(13,35,23,.55)}
.k{color:var(--muted);font-size:12px;font-weight:800}
.v{font-weight:900;font-size:13px}
.small{color:var(--muted);font-size:12px;line-height:1.45;margin-top:10px;font-weight:600}
footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center;font-weight:600}
.empty{padding:16px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);color:var(--muted);text-align:center}

/* ===== MODAL ===== */
.modalOverlay{position:fixed; inset:0;background: rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;padding: 14px;z-index: 9999;}
.modalOverlay.show{display:flex}
.modal{width:min(920px, 100%);max-height: 92vh;border-radius: 22px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background: linear-gradient(180deg, rgba(10,16,14,.96), rgba(6,10,8,.96));box-shadow: 0 30px 90px rgba(0,0,0,.65);}
.modalTop{
  --homeLogoUrl:none; --awayLogoUrl:none;
  --homeTint: rgba(239,68,68,.18);
  --awayTint: rgba(96,165,250,.16);
  --homeBar: rgba(239,68,68,.90);
  --awayBar: rgba(96,165,250,.90);
  position:relative;padding: 16px;border-bottom:1px solid rgba(255,255,255,.08);overflow:hidden;
}
.modalTop::before{
  content:"";position:absolute; inset:-60px;
  background:
    var(--homeLogoUrl) left 10% top 25% / 280px 280px no-repeat,
    var(--awayLogoUrl) right 10% top 25% / 280px 280px no-repeat,
    radial-gradient(720px 360px at 18% 20%, var(--homeTint), transparent 65%),
    radial-gradient(720px 360px at 85% 15%, var(--awayTint), transparent 65%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
  filter: blur(20px);opacity:.95;pointer-events:none;
}
.modalTop::after{content:"";position:absolute; inset:0;background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.08));pointer-events:none;}
.modalTop > *{position:relative; z-index:1}
.modalHeaderRow{display:flex; justify-content:space-between; align-items:center; gap:10px;}
.pillMini{display:inline-flex; align-items:center; gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);color: var(--muted);font-weight:800;font-size:12px;}
.closeBtn{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);color: var(--txt);border-radius: 999px;padding: 8px 10px;font-weight: 900;cursor:pointer;}
.modalScoreRow{margin-top: 14px;display:grid;grid-template-columns: 1fr auto 1fr;align-items:center;gap: 14px;}
.modalTeam{display:flex; gap:12px; align-items:center; min-width:0;}
.modalTeam.right{justify-content:flex-end}
.modalBigLogo{width:54px;height:54px;border-radius: 18px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);object-fit:contain}
.modalTeam .tname{font-weight:900;font-size:14px;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.modalScore{display:flex; flex-direction:column; align-items:center; gap:6px; min-width:140px;}
.modalScore .big{font-weight:900;font-variant-numeric: tabular-nums;font-size: 38px;line-height: 1;letter-spacing:-0.02em;}
.modalScore .status{color: var(--muted);font-weight:800;font-size: 12px;letter-spacing:.06em;text-transform:uppercase;}
.modalTabs{display:flex; gap:10px;padding: 12px 14px;border-bottom:1px solid rgba(255,255,255,.08);background: rgba(255,255,255,.02);overflow:auto;}
.modalTab{white-space:nowrap;padding:10px 12px;border-radius:999px;border:1px solid transparent;background: transparent;color: var(--muted);font-weight: 900;cursor:pointer;font-size:13px;}
.modalTab.active{color: var(--txt);border-color: rgba(255,255,255,.12);background: rgba(255,255,255,.06);}
.modalBody{padding: 14px;max-height: calc(92vh - 230px);overflow:auto;}
.cardBlock{border:1px solid rgba(255,255,255,.08);background: rgba(255,255,255,.03);border-radius: 18px;padding: 12px;}

/* Stats (formal + fino) */
.statsFont{font-family:"Source Sans 3", Inter, system-ui}
.statsTitle{font-weight:800;color:var(--txt);font-size:13px;letter-spacing:.06em;text-transform:uppercase;margin:0 0 10px}
.statItem{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.12);margin-bottom:10px}
.statLabel{color:var(--muted);font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px}
.statLine{display:grid;grid-template-columns:38px 1fr 38px;gap:10px;align-items:center}
.statNum{font-variant-numeric:tabular-nums;font-weight:800;font-size:13px;text-align:center}
.track{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;position:relative}
.fillL{height:100%;border-radius:999px;position:absolute;left:0;top:0}
.fillR{height:100%;border-radius:999px;position:absolute;right:0;top:0}

.playerBlock{margin-top:14px}
.playerHeader{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px}
.playerHeader .team{font-weight:900;font-size:14px}
.playerList{display:flex;flex-direction:column;gap:8px}
.playerRow{
  display:grid;
  grid-template-columns:34px 1fr 70px;
  gap:10px;
  align-items:center;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.12);
}
.pNo{color:var(--muted);font-weight:800;font-variant-numeric:tabular-nums;text-align:center}
.pName{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pBadges{display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap}
.badg{font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted)}
.badg.g{color:#fff;border-color:rgba(255,255,255,.18)}
.badg.y{color:#fcd34d;border-color:rgba(252,211,77,.35);background:rgba(252,211,77,.10)}
.badg.r{color:#fb7185;border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}
.badg.in{color:#34d399;border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.10)}
.badg.out{color:#60a5fa;border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.10)}
.smallMuted{color:var(--muted); font-size:12px; font-weight:700}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="brandTitle">
        <div class="h">Marcadores ‚Äî Pro TV</div>
        <div class="p">Jornadas + d√≠as + detalle tipo app</div>
      </div>
    </div>

    <div class="controls">
      <div class="pill"><span>üîé</span><input id="search" placeholder="Buscar equipo‚Ä¶" /></div>
      <button class="btn" id="prevRound">‚¨Ö</button>
      <select class="btn select" id="roundSelect"></select>
      <button class="btn" id="nextRound">‚û°</button>
      <button class="btn" id="modeBtn">Modo: JORNADA</button>
      <button class="btn primary" id="refreshBtn">‚Üª Actualizar</button>
    </div>

    <div class="legend">
      <span><span class="dot past"></span>Pasada</span>
      <span><span class="dot current"></span>Actual</span>
      <span><span class="dot future"></span>Futura</span>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Ligas">
    <button class="tab" role="tab" aria-selected="true" data-league="EPL">Premier League</button>
    <button class="tab" role="tab" aria-selected="false" data-league="LL">LaLiga</button>
    <button class="tab" role="tab" aria-selected="false" data-league="L1">Ligue 1</button>
  </nav>

  <div class="grid">
    <section class="panel">
      <h2 id="leagueTitle">Premier League ‚Äî Jornada</h2>
      <div id="matches" class="list"></div>
    </section>

    <aside class="panel">
      <h2>Resumen</h2>
      <div class="kv"><div class="k">Liga activa</div><div class="v" id="activeLeague">Premier League</div></div>
      <div class="kv"><div class="k">Modo</div><div class="v" id="modeLabel">JORNADA</div></div>
      <div class="kv"><div class="k">Jornada</div><div class="v" id="roundLabel">‚Äî</div></div>
      <div class="kv"><div class="k">Partidos</div><div class="v" id="count">0</div></div>
      <div class="kv"><div class="k">LIVE</div><div class="v" id="liveCount">0</div></div>
      <div class="kv"><div class="k">FT</div><div class="v" id="ftCount">0</div></div>
      <div class="kv"><div class="k">√öltima</div><div class="v" id="updated">‚Äî</div></div>
      <div class="small" id="note">Cargando jornadas‚Ä¶</div>
    </aside>
  </div>

  <footer>Pro TV ‚Äî clic en partido abre detalle</footer>
</div>

<!-- MODAL -->
<div class="modalOverlay" id="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Detalle del partido">
    <div class="modalTop" id="modalTop">
      <div class="modalHeaderRow">
        <div class="pillMini" id="modalLeague">Liga</div>
        <button class="closeBtn" id="closeModal">‚úï</button>
      </div>

      <div class="modalScoreRow">
        <div class="modalTeam" id="modalHome"></div>
        <div class="modalScore">
          <div class="big" id="modalScore">‚Äî</div>
          <div class="status" id="modalStatus">‚Äî</div>
        </div>
        <div class="modalTeam right" id="modalAway"></div>
      </div>
    </div>

    <div class="modalTabs">
      <button class="modalTab active" data-tab="overview">Overview</button>
      <button class="modalTab" data-tab="stats">Stats</button>
      <button class="modalTab" data-tab="events">Play-by-Play</button>
      <button class="modalTab" data-tab="standings">Standings</button>
    </div>

    <div class="modalBody">
      <div id="tab_overview" class="cardBlock statsFont"></div>
      <div id="tab_stats" class="cardBlock statsFont" style="display:none"></div>
      <div id="tab_events" class="cardBlock" style="display:none"></div>
      <div id="tab_standings" class="cardBlock" style="display:none"></div>
    </div>
  </div>
</div>

<script>
const LEAGUES = { EPL:{name:"Premier League",id:39}, LL:{name:"LaLiga",id:140}, L1:{name:"Ligue 1",id:61} };
function getCurrentSeason(){ const d=new Date(); const y=d.getFullYear(); const m=d.getMonth()+1; return (m>=7)?y:(y-1); }
const SEASON=getCurrentSeason();
const TZ="America/Mexico_City";

let active="EPL", mode="round", query="";
let currentData=[], rounds=[], roundIndex=0;
let roundsCache=new Map(), currentRoundCache=new Map();
let lastClickedEl=null, selectedMatch=null;

const elMatches=document.getElementById("matches");
const elTitle=document.getElementById("leagueTitle");
const elActive=document.getElementById("activeLeague");
const elCount=document.getElementById("count");
const elLive=document.getElementById("liveCount");
const elFt=document.getElementById("ftCount");
const elUpdated=document.getElementById("updated");
const elModeLabel=document.getElementById("modeLabel");
const elRoundLabel=document.getElementById("roundLabel");
const elNote=document.getElementById("note");

const roundSelect=document.getElementById("roundSelect");
const prevRoundBtn=document.getElementById("prevRound");
const nextRoundBtn=document.getElementById("nextRound");
const modeBtn=document.getElementById("modeBtn");
const refreshBtn=document.getElementById("refreshBtn");

// modal dom
const modalOverlay=document.getElementById("modalOverlay");
const modalTop=document.getElementById("modalTop");
const closeModalBtn=document.getElementById("closeModal");
const modalLeague=document.getElementById("modalLeague");
const modalHome=document.getElementById("modalHome");
const modalAway=document.getElementById("modalAway");
const modalScore=document.getElementById("modalScore");
const modalStatus=document.getElementById("modalStatus");

const tabOverview=document.getElementById("tab_overview");
const tabStats=document.getElementById("tab_stats");
const tabEvents=document.getElementById("tab_events");
const tabStandings=document.getElementById("tab_standings");

function normalizeStatus(short){ if(!short)return"NS"; if(short==="FT"||short==="AET"||short==="PEN")return"FT"; if(short==="NS")return"NS"; return"LIVE"; }
function periodFromShort(short){
  if(!short)return""; if(short==="1H")return"1T"; if(short==="2H")return"2T"; if(short==="HT")return"DESCANSO";
  if(short==="ET")return"TE"; if(short==="PEN")return"PENALES"; if(short==="FT"||short==="AET")return"FINAL";
  if(short==="NS")return"PR√ìXIMO"; return"EN JUEGO";
}
function badge(status){
  if(status==="LIVE")return`<span class="badge live">LIVE</span>`;
  if(status==="FT")return`<span class="badge ft">FT</span>`;
  return`<span class="badge ns">NS</span>`;
}
function sublineText(m){
  if(m.status==="LIVE"){ const add=(typeof m.added==="number")?` ¬∑ +${m.added}`:""; return`${m.period||"EN JUEGO"}${add}`; }
  if(m.status==="FT")return"FINAL";
  return"PR√ìXIMO";
}
function scoreHTML(m){
  if(m.status==="NS")return`<div class="scoreCenter"><div class="vs">VS</div></div>`;
  return`<div class="scoreCenter"><div class="n">${m.h??0}</div><div class="dash">‚Äì</div><div class="n">${m.a??0}</div></div>`;
}
function logoImg(src, alt, cls="logoBig"){
  const fallback="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' rx='14' ry='14' fill='rgba(255,255,255,0.08)'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='30'%3E%E2%9A%BD%3C/text%3E%3C/svg%3E";
  return `<img class="${cls}" src="${src||fallback}" alt="${alt}" loading="lazy" onerror="this.onerror=null;this.src='${fallback}'">`;
}

function mapFixtures(json){
  const fixtures=(json&&json.response)?json.response:[];
  return fixtures.map(f=>{
    const short=f.fixture?.status?.short;
    const status=normalizeStatus(short);
    const elapsed=f.fixture?.status?.elapsed;
    const added=f.fixture?.status?.extra;
    const dateISO=f.fixture?.date||null;
    return{
      id:String(f.fixture?.id),
      fixtureId:f.fixture?.id,
      leagueId:f.league?.id,
      leagueName:f.league?.name||"",
      dateISO,
      time:dateISO?new Date(dateISO).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"}):"--:--",
      status,
      minute:(status==="LIVE"&&typeof elapsed==="number")?`${elapsed}'`:"",
      period:periodFromShort(short),
      added:(status==="LIVE"&&typeof added==="number")?added:undefined,
      home:f.teams?.home?.name||"Home",
      away:f.teams?.away?.name||"Away",
      homeId:f.teams?.home?.id,
      awayId:f.teams?.away?.id,
      homeLogo:f.teams?.home?.logo||"",
      awayLogo:f.teams?.away?.logo||"",
      h:f.goals?.home,
      a:f.goals?.away
    };
  });
}

async function api(endpoint, params){
  const u=new URL("/.netlify/functions/football", location.origin);
  u.searchParams.set("endpoint", endpoint);
  u.searchParams.set("timezone", TZ);
  Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=="") u.searchParams.set(k,String(v)); });
  const res=await fetch(u.toString());
  return res.json();
}

function applySearch(arr){
  if(!query)return arr;
  const q=query.toLowerCase();
  return arr.filter(m=>m.home.toLowerCase().includes(q)||m.away.toLowerCase().includes(q));
}

function dayKeyFromISO(iso){
  if(!iso)return"unknown";
  const d=new Date(iso);
  return new Intl.DateTimeFormat("en-CA",{timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit"}).format(d);
}
function dayTitleFromKey(key){
  const [y,m,d]=key.split("-").map(Number);
  const dt=new Date(Date.UTC(y,m-1,d,12,0,0));
  const pretty=new Intl.DateTimeFormat("es-MX",{timeZone:TZ,weekday:"long",day:"numeric",month:"long"}).format(dt);
  return pretty.charAt(0).toUpperCase()+pretty.slice(1);
}
function groupByDay(arr){
  const map=new Map();
  arr.forEach(m=>{
    const k=dayKeyFromISO(m.dateISO);
    if(!map.has(k))map.set(k,[]);
    map.get(k).push(m);
  });
  const keys=[...map.keys()].sort((a,b)=>a==="unknown"?1:b==="unknown"?-1:a.localeCompare(b));
  keys.forEach(k=>map.get(k).sort((a,b)=>(new Date(a.dateISO||0)).getTime()-(new Date(b.dateISO||0)).getTime()));
  return keys.map(k=>({dayKey:k,items:map.get(k)}));
}

const FINISHED=new Set(["FT","AET","PEN"]);
function isRoundFinished(fixturesRaw){ if(!fixturesRaw.length)return false; return fixturesRaw.every(f=>FINISHED.has(f.fixture?.status?.short)); }

async function getRoundsRaw(leagueKey){
  if(roundsCache.has(leagueKey))return roundsCache.get(leagueKey);
  const meta=LEAGUES[leagueKey];
  const j=await api("rounds",{league:meta.id,season:SEASON});
  const arr=j.response||[];
  roundsCache.set(leagueKey,arr);
  return arr;
}
async function fetchFixturesRawByRound(leagueKey, round){
  const meta=LEAGUES[leagueKey];
  const j=await api("fixtures",{league:meta.id,season:SEASON,round});
  return j.response||[];
}
async function detectCurrentRound(leagueKey){
  if(currentRoundCache.has(leagueKey))return currentRoundCache.get(leagueKey);
  const roundsRaw=await getRoundsRaw(leagueKey);
  if(!roundsRaw.length)return null;
  let lo=0,hi=roundsRaw.length-1,ans=null;
  while(lo<=hi){
    const mid=Math.floor((lo+hi)/2);
    const round=roundsRaw[mid];
    const fixturesRaw=await fetchFixturesRawByRound(leagueKey,round);
    const finished=isRoundFinished(fixturesRaw);
    if(finished)lo=mid+1; else {ans=round;hi=mid-1;}
  }
  if(!ans)ans=roundsRaw[roundsRaw.length-1];
  currentRoundCache.set(leagueKey,ans);
  return ans;
}
function roundPretty(s){return s.replace("Regular Season -","Jornada").trim();}
function statusEmoji(st){return st==="current"?"üü¢":st==="future"?"üîµ":"‚ö´";}

function renderRoundSelector(){
  roundSelect.innerHTML="";
  rounds.forEach((r,i)=>{
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=`${statusEmoji(r.status)} ${roundPretty(r.round)} (${r.status==="current"?"Actual":r.status==="past"?"Pasada":"Futura"})`;
    if(i===roundIndex)opt.selected=true;
    roundSelect.appendChild(opt);
  });
  prevRoundBtn.disabled=(roundIndex<=0);
  nextRoundBtn.disabled=(roundIndex>=rounds.length-1);
}

function card(m){
  return `
  <article class="match" data-fixture="${m.id}">
    <div class="time">
      <span class="kickoff">${m.time}</span>
      ${badge(m.status)}
      ${m.status==="LIVE"?`<span class="minute">${m.minute||""}</span>`:""}
    </div>
    <div class="broadcast">
      ${logoImg(m.homeLogo, m.home + " logo")}
      <div class="scoreWrap">
        ${scoreHTML(m)}
        <div class="subline">${sublineText(m)}</div>
      </div>
      ${logoImg(m.awayLogo, m.away + " logo")}
    </div>
  </article>`;
}

function render(arr){
  const meta=LEAGUES[active];
  const filtered=applySearch(arr);

  elActive.textContent=meta.name;
  elModeLabel.textContent=(mode==="round")?"JORNADA":"LIVE";
  elTitle.textContent=`${meta.name} ‚Äî ${(mode==="round")?"Jornada":"En vivo"}`;

  elCount.textContent=String(filtered.length);
  elLive.textContent=String(filtered.filter(x=>x.status==="LIVE").length);
  elFt.textContent=String(filtered.filter(x=>x.status==="FT").length);
  elUpdated.textContent=new Date().toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});

  if(filtered.length===0){
    elMatches.innerHTML=`<div class="empty">No hay partidos para mostrar.</div>`;
    return;
  }

  const grouped=groupByDay(filtered);
  elMatches.innerHTML=grouped.map(g=>{
    const title=g.dayKey==="unknown"?"Sin fecha":dayTitleFromKey(g.dayKey);
    return `
      <div class="dayHeader">
        <div>
          <div class="title">${title}</div>
          <div class="sub">Partidos del d√≠a</div>
        </div>
        <div class="count">${g.items.length} partidos</div>
      </div>
      ${g.items.map(card).join("")}
    `;
  }).join("");

  elMatches.querySelectorAll(".match").forEach(cardEl=>{
    cardEl.addEventListener("click", ()=>{
      if(lastClickedEl)lastClickedEl.classList.remove("selected");
      cardEl.classList.add("selected");
      lastClickedEl=cardEl;

      const id=cardEl.getAttribute("data-fixture");
      const m=currentData.find(x=>x.id===id);
      if(m)openMatchModal(m);
    });
  });
}

async function loadRoundByIndex(idx){
  roundIndex=idx;
  renderRoundSelector();
  const meta=LEAGUES[active];
  const r=rounds[roundIndex];
  elRoundLabel.textContent=`${roundPretty(r.round)} (${r.status==="current"?"Actual":r.status==="past"?"Pasada":"Futura"})`;
  const j=await api("fixtures",{league:meta.id,season:SEASON,round:r.round});
  currentData=mapFixtures(j);
  render(currentData);
}

async function fallbackNextFixtures(){
  const meta=LEAGUES[active];
  elNote.textContent="No hay rounds disponibles. Mostrando pr√≥ximos partidos‚Ä¶";
  const j=await api("fixtures",{league:meta.id,season:SEASON,next:15});
  currentData=mapFixtures(j);
  elRoundLabel.textContent="Pr√≥ximos";
  render(currentData);
}

async function refresh(){
  try{
    const meta=LEAGUES[active];
    elNote.textContent="Cargando‚Ä¶";

    if(mode==="live"){
      elRoundLabel.textContent="‚Äî";
      const j=await api("fixtures",{league:meta.id,season:SEASON,live:"all"});
      currentData=mapFixtures(j);
      elNote.textContent="OK: LIVE.";
      render(currentData);
      return;
    }

    const roundsRaw=await getRoundsRaw(active);
    if(!roundsRaw.length){ await fallbackNextFixtures(); return; }

    const currentRound=await detectCurrentRound(active);
    const currentIdx=Math.max(0, roundsRaw.indexOf(currentRound));

    rounds=roundsRaw.map((round,idx)=>({ round,index:idx,status: idx<currentIdx?"past":(idx===currentIdx?"current":"future") }));
    roundIndex=currentIdx;
    renderRoundSelector();

    await loadRoundByIndex(roundIndex);
    elNote.textContent="OK.";
  }catch(err){
    elMatches.innerHTML = `<div class="empty">Error cargando datos.<br><br><span style="opacity:.8">${String(err)}</span></div>`;
    elNote.textContent = "Error.";
  }
}

/* ===== Modal / Tabs ===== */
function setActiveModalTab(key){
  document.querySelectorAll(".modalTab").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.modalTab[data-tab="${key}"]`).classList.add("active");

  tabOverview.style.display = (key==="overview") ? "block" : "none";
  tabStats.style.display = (key==="stats") ? "block" : "none";
  tabEvents.style.display = (key==="events") ? "block" : "none";
  tabStandings.style.display = (key==="standings") ? "block" : "none";
}
document.querySelectorAll(".modalTab").forEach(btn=>btn.addEventListener("click", ()=> setActiveModalTab(btn.dataset.tab)));

closeModalBtn.addEventListener("click", closeMatchModal);
modalOverlay.addEventListener("click",(e)=>{ if(e.target===modalOverlay)closeMatchModal(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalOverlay.classList.contains("show"))closeMatchModal(); });

function closeMatchModal(){
  modalOverlay.classList.remove("show");
  document.body.style.overflow="";
  selectedMatch=null;
}

function renderModalLoading(){
  tabOverview.innerHTML = `<div class="smallMuted">Cargando overview‚Ä¶</div>`;
  tabStats.innerHTML = `<div class="smallMuted">Cargando stats y jugadores‚Ä¶</div>`;
  tabEvents.innerHTML = `<div class="smallMuted">Cargando eventos‚Ä¶</div>`;
  tabStandings.innerHTML = `<div class="smallMuted">Cargando standings‚Ä¶</div>`;
}

function toNum(v){
  if (v == null) return 0;
  if (typeof v === "number") return v;
  const s = String(v).replace("%","").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function statCompact(label, homeVal, awayVal){
  const h = toNum(homeVal);
  const a = toNum(awayVal);
  const total = (h + a) || 1;
  const hp = Math.round((h/total)*100);
  const ap = 100 - hp;

  return `
    <div class="statItem">
      <div class="statLabel">${label}</div>
      <div class="statLine">
        <div class="statNum">${homeVal ?? 0}</div>
        <div class="track">
          <div class="fillL" style="width:${hp}%; background: var(--homeBar);"></div>
          <div class="fillR" style="width:${ap}%; background: var(--awayBar);"></div>
        </div>
        <div class="statNum">${awayVal ?? 0}</div>
      </div>
    </div>
  `;
}

function pickStat(statsArr, teamName, key){
  const team = statsArr.find(x => x.team?.name === teamName) || statsArr[0];
  const list = team?.statistics || [];
  const item = list.find(s => s.type === key);
  return item ? item.value : null;
}

function buildEventMaps(eventsJ){
  const ev = (eventsJ && eventsJ.response) ? eventsJ.response : [];

  const goalsByTeam = { home: [], away: [] };
  const cardsByTeam = { home: { y:0, r:0 }, away: { y:0, r:0 } };
  const subsByTeam = { home: [], away: [] };

  for (const e of ev){
    const teamName = e.team?.name || "";
    const min = e.time?.elapsed != null ? `${e.time.elapsed}'` : "";
    const t = e.type;
    const d = e.detail || "";
    const player = e.player?.name || "";
    const assist = e.assist?.name || "";
    const isHome = teamName === selectedMatch?.home;
    const side = isHome ? "home" : "away";

    if (t === "Goal"){
      const pen = (d.toLowerCase().includes("penalty") || d.toLowerCase().includes("pen")) ? " (P)" : "";
      goalsByTeam[side].push(`${player} ${min}${pen}`);
    }

    if (t === "Card"){
      if (d.includes("Yellow")) cardsByTeam[side].y += 1;
      if (d.includes("Red")) cardsByTeam[side].r += 1;
    }

    if (t === "subst"){
      // player sale, assist entra
      subsByTeam[side].push(`${assist || "‚¨Ü"} / ${player || "‚¨á"} ${min}`);
    }
  }

  return { goalsByTeam, cardsByTeam, subsByTeam, raw: ev };
}

function renderModalOverview(match, eventsJ){
  const maps = buildEventMaps(eventsJ);

  const homeGoals = maps.goalsByTeam.home;
  const awayGoals = maps.goalsByTeam.away;

  const homeCards = maps.cardsByTeam.home;
  const awayCards = maps.cardsByTeam.away;

  const homeSubs = maps.subsByTeam.home;
  const awaySubs = maps.subsByTeam.away;

  tabOverview.innerHTML = `
    <div class="statsTitle">Overview</div>

    <div class="statItem">
      <div class="statLabel">Goles</div>
      <div class="smallMuted"><b>${match.home}</b>: ${homeGoals.length ? homeGoals.join(" ¬∑ ") : "‚Äî"}</div>
      <div class="smallMuted" style="margin-top:6px"><b>${match.away}</b>: ${awayGoals.length ? awayGoals.join(" ¬∑ ") : "‚Äî"}</div>
    </div>

    <div class="statItem">
      <div class="statLabel">Tarjetas</div>
      <div class="smallMuted"><b>${match.home}</b>: üü® ${homeCards.y} ¬∑ üü• ${homeCards.r}</div>
      <div class="smallMuted" style="margin-top:6px"><b>${match.away}</b>: üü® ${awayCards.y} ¬∑ üü• ${awayCards.r}</div>
    </div>

    <div class="statItem">
      <div class="statLabel">Cambios</div>
      <div class="smallMuted"><b>${match.home}</b>: ${homeSubs.length ? homeSubs.slice(0,6).join(" ¬∑ ") : "‚Äî"}</div>
      <div class="smallMuted" style="margin-top:6px"><b>${match.away}</b>: ${awaySubs.length ? awaySubs.slice(0,6).join(" ¬∑ ") : "‚Äî"}</div>
    </div>

    <div class="smallMuted" style="margin-top:10px">Tip: en ‚ÄúPlay-by-Play‚Äù tienes el detalle completo.</div>
  `;
}

function renderModalStatsReal(match, statsJ, eventsJ, lineupsJ){
  const statsArr = (statsJ && statsJ.response) ? statsJ.response : [];

  const possH = pickStat(statsArr, match.home, "Ball Possession");
  const possA = pickStat(statsArr, match.away, "Ball Possession");
  const shotsH = pickStat(statsArr, match.home, "Total Shots");
  const shotsA = pickStat(statsArr, match.away, "Total Shots");
  const sogH = pickStat(statsArr, match.home, "Shots on Goal");
  const sogA = pickStat(statsArr, match.away, "Shots on Goal");
  const cornersH = pickStat(statsArr, match.home, "Corner Kicks");
  const cornersA = pickStat(statsArr, match.away, "Corner Kicks");
  const foulsH = pickStat(statsArr, match.home, "Fouls");
  const foulsA = pickStat(statsArr, match.away, "Fouls");
  const yH = pickStat(statsArr, match.home, "Yellow Cards");
  const yA = pickStat(statsArr, match.away, "Yellow Cards");
  const rH = pickStat(statsArr, match.home, "Red Cards");
  const rA = pickStat(statsArr, match.away, "Red Cards");

  const evMaps = buildEventMaps(eventsJ);

  const lineups = (lineupsJ && lineupsJ.response) ? lineupsJ.response : [];
  const homeLU = lineups.find(l => l.team?.id === match.homeId) || lineups[0];
  const awayLU = lineups.find(l => l.team?.id === match.awayId) || lineups[1];

  function renderPlayersBlock(lu, isHome){
    if (!lu) return `<div class="smallMuted">Sin alineaci√≥n disponible.</div>`;
    const start = (lu.startXI || []).map(x => x.player);
    const subs = (lu.substitutes || []).map(x => x.player);
    const teamName = lu.team?.name || (isHome ? match.home : match.away);

    const events = evMaps.raw || [];

    function badgesForPlayer(p){
      const pid = p.id;
      const out = [];

      for (const e of events){
        const min = e.time?.elapsed != null ? `${e.time.elapsed}'` : "";
        if (e.type === "Goal" && e.player?.id === pid) {
          const pen = (String(e.detail||"").toLowerCase().includes("pen")) ? " (P)" : "";
          out.push(`<span class="badg g">‚öΩ ${min}${pen}</span>`);
        }
        if (e.type === "Card" && e.player?.id === pid) {
          if (String(e.detail||"").includes("Yellow")) out.push(`<span class="badg y">üü® ${min}</span>`);
          if (String(e.detail||"").includes("Red")) out.push(`<span class="badg r">üü• ${min}</span>`);
        }
        if (e.type === "subst"){
          // player sale
          if (e.player?.id === pid) out.push(`<span class="badg out">üîª ${min}</span>`);
          // assist entra
          if (e.assist?.id === pid) out.push(`<span class="badg in">üî∫ ${min}</span>`);
        }
      }
      return out.join("");
    }

    const renderRow = (p) => `
      <div class="playerRow">
        <div class="pNo">${p.number ?? "‚Äî"}</div>
        <div class="pName">${p.name ?? "‚Äî"}</div>
        <div class="pBadges">${badgesForPlayer(p) || ""}</div>
      </div>
    `;

    return `
      <div class="playerBlock">
        <div class="playerHeader">
          <div class="team">${teamName}</div>
          <div class="smallMuted">${isHome ? "Local" : "Visita"}</div>
        </div>

        <div class="smallMuted" style="margin:6px 0 8px">Titulares</div>
        <div class="playerList">${start.map(renderRow).join("")}</div>

        <div class="smallMuted" style="margin:12px 0 8px">Banca</div>
        <div class="playerList">${subs.map(renderRow).join("")}</div>
      </div>
    `;
  }

  tabStats.innerHTML = `
    <div class="statsTitle">Team Stats</div>
    ${statCompact("Posesi√≥n", possH, possA)}
    ${statCompact("Tiros", shotsH, shotsA)}
    ${statCompact("Tiros a puerta", sogH, sogA)}
    ${statCompact("Corners", cornersH, cornersA)}
    ${statCompact("Faltas", foulsH, foulsA)}
    ${statCompact("Amarillas", yH, yA)}
    ${statCompact("Rojas", rH, rA)}

    <div class="statsTitle" style="margin-top:16px">Jugadores</div>
    ${renderPlayersBlock(homeLU, true)}
    <div style="height:12px"></div>
    ${renderPlayersBlock(awayLU, false)}
  `;
}

function renderModalEventsReal(match, eventsJ){
  const ev = (eventsJ && eventsJ.response) ? eventsJ.response : [];
  if (!ev.length){
    tabEvents.innerHTML = `<div class="smallMuted">No hay eventos disponibles.</div>`;
    return;
  }

  const rows = ev
    .slice()
    .sort((a,b)=>(a.time?.elapsed||0)-(b.time?.elapsed||0))
    .map(e=>{
      const min = e.time?.elapsed != null ? `${e.time.elapsed}'` : "‚Äî";
      const team = e.team?.name || "";
      const player = e.player?.name || team;
      const detail = e.detail || "";
      const type = e.type || "";

      let icon = "‚Ä¢";
      if (type === "Goal") icon = "‚öΩ";
      if (type === "Card" && detail.includes("Yellow")) icon = "üü®";
      if (type === "Card" && detail.includes("Red")) icon = "üü•";
      if (type === "subst") icon = "üîÅ";

      return `
        <div class="playerRow" style="grid-template-columns: 64px 1fr 120px">
          <div class="pNo" style="text-align:left">${min} ${icon}</div>
          <div class="pName" title="${team}">${player} ‚Äî ${detail}</div>
          <div class="pBadges"><span class="badg">${type}</span></div>
        </div>
      `;
    }).join("");

  tabEvents.innerHTML = `
    <div class="statsTitle">Play-by-Play</div>
    <div class="playerList">${rows}</div>
  `;
}

function renderModalStandingsReal(match, standingsJ){
  const leagues = standingsJ?.response?.[0]?.league;
  const table = leagues?.standings?.[0] || [];

  if (!table.length){
    tabStandings.innerHTML = `<div class="smallMuted">No hay standings disponibles.</div>`;
    return;
  }

  const home = (match.home || "").toLowerCase();
  const away = (match.away || "").toLowerCase();

  const rows = table.slice(0, 20).map(r=>{
    const name = r.team?.name || "";
    const isFocus = name.toLowerCase() === home || name.toLowerCase() === away;

    return `
      <div class="playerRow" style="grid-template-columns: 38px 1fr 60px; ${isFocus ? "border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.05);" : ""}">
        <div class="pNo">${r.rank}</div>
        <div class="pName">${name}</div>
        <div class="pBadges"><span class="badg">Pts ${r.points}</span></div>
      </div>
    `;
  }).join("");

  tabStandings.innerHTML = `
    <div class="statsTitle">Standings</div>
    <div class="playerList">${rows}</div>
  `;
}

/* ‚úÖ Colores: intentamos sacar color del escudo; si falla, fallback */
async function getDominantColor(url){
  return new Promise((resolve)=>{
    try{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.referrerPolicy = "no-referrer";
      img.onload = () => {
        try{
          const c = document.createElement("canvas");
          const ctx = c.getContext("2d", { willReadFrequently:true });
          const w = 32, h = 32;
          c.width = w; c.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0,0,w,h).data;

          let r=0,g=0,b=0,count=0;
          for(let i=0;i<data.length;i+=16){
            const rr=data[i], gg=data[i+1], bb=data[i+2], aa=data[i+3];
            if (aa < 140) continue;
            const max = Math.max(rr,gg,bb);
            const min = Math.min(rr,gg,bb);
            if (max > 245 && min > 245) continue;
            if (max < 18 && min < 18) continue;
            r+=rr; g+=gg; b+=bb; count++;
          }
          if (!count) return resolve(null);
          resolve({r:Math.round(r/count), g:Math.round(g/count), b:Math.round(b/count)});
        } catch { resolve(null); }
      };
      img.onerror = () => resolve(null);
      img.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
    } catch { resolve(null); }
  });
}
function rgba(c,a){ return `rgba(${c.r},${c.g},${c.b},${a})`; }

function setActiveModalTabSafe(key){ setActiveModalTab(key); }

async function loadMatchDetails(match){
  const fixture = match.fixtureId;

  const [statsJ, eventsJ, lineupsJ, standingsJ] = await Promise.all([
    api("statistics", { fixture }),
    api("events", { fixture }),
    api("lineups", { fixture }),
    api("standings", { league: match.leagueId || LEAGUES[active].id, season: SEASON })
  ]);

  renderModalOverview(match, eventsJ);
  renderModalStatsReal(match, statsJ, eventsJ, lineupsJ);
  renderModalEventsReal(match, eventsJ);
  renderModalStandingsReal(match, standingsJ);
}

async function openMatchModal(match){
  selectedMatch = match;
  modalOverlay.classList.add("show");
  document.body.style.overflow = "hidden";

  modalTop.style.setProperty("--homeLogoUrl", `url("${match.homeLogo}")`);
  modalTop.style.setProperty("--awayLogoUrl", `url("${match.awayLogo}")`);

  // set header info
  modalLeague.textContent = match.leagueName || LEAGUES[active].name;
  modalHome.innerHTML = `${logoImg(match.homeLogo, match.home, "modalBigLogo")}<div class="tname">${match.home}</div>`;
  modalAway.innerHTML = `<div class="tname">${match.away}</div>${logoImg(match.awayLogo, match.away, "modalBigLogo")}`;
  modalScore.textContent = (match.status === "NS") ? "‚Äî" : `${match.h ?? 0} ‚Äì ${match.a ?? 0}`;
  modalStatus.textContent = (match.status === "FT") ? "Final" : (match.status === "LIVE") ? `En juego ${match.minute || ""}` : "Pr√≥ximo";

  renderModalLoading();
  setActiveModalTabSafe("overview");

  // intentar color real del escudo
  const [hc, ac] = await Promise.all([ getDominantColor(match.homeLogo), getDominantColor(match.awayLogo) ]);
  if (hc) {
    modalTop.style.setProperty("--homeTint", rgba(hc, .18));
    modalTop.style.setProperty("--homeBar", rgba(hc, .90));
  } else {
    modalTop.style.setProperty("--homeTint", "rgba(239,68,68,.18)");
    modalTop.style.setProperty("--homeBar", "rgba(239,68,68,.90)");
  }
  if (ac) {
    modalTop.style.setProperty("--awayTint", rgba(ac, .16));
    modalTop.style.setProperty("--awayBar", rgba(ac, .90));
  } else {
    modalTop.style.setProperty("--awayTint", "rgba(96,165,250,.16)");
    modalTop.style.setProperty("--awayBar", "rgba(96,165,250,.90)");
  }

  loadMatchDetails(match).catch(err=>{
    tabOverview.innerHTML = `<div class="smallMuted">No se pudo cargar overview.<br>${String(err)}</div>`;
    tabStats.innerHTML = `<div class="smallMuted">No se pudo cargar stats/jugadores.</div>`;
    tabEvents.innerHTML = `<div class="smallMuted">No se pudo cargar eventos.</div>`;
    tabStandings.innerHTML = `<div class="smallMuted">No se pudo cargar standings.</div>`;
  });
}

/* ===== Main list helpers ===== */
function card(m){
  return `
  <article class="match" data-fixture="${m.id}">
    <div class="time">
      <span class="kickoff">${m.time}</span>
      ${badge(m.status)}
      ${m.status==="LIVE"?`<span class="minute">${m.minute||""}</span>`:""}
    </div>
    <div class="broadcast">
      ${logoImg(m.homeLogo, m.home + " logo")}
      <div class="scoreWrap">
        ${scoreHTML(m)}
        <div class="subline">${sublineText(m)}</div>
      </div>
      ${logoImg(m.awayLogo, m.away + " logo")}
    </div>
  </article>`;
}

function renderList(arr){
  const meta=LEAGUES[active];
  const filtered=applySearch(arr);

  elActive.textContent=meta.name;
  elModeLabel.textContent=(mode==="round")?"JORNADA":"LIVE";
  elTitle.textContent=`${meta.name} ‚Äî ${(mode==="round")?"Jornada":"En vivo"}`;

  elCount.textContent=String(filtered.length);
  elLive.textContent=String(filtered.filter(x=>x.status==="LIVE").length);
  elFt.textContent=String(filtered.filter(x=>x.status==="FT").length);
  elUpdated.textContent=new Date().toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});

  if(filtered.length===0){
    elMatches.innerHTML=`<div class="empty">No hay partidos para mostrar.</div>`;
    return;
  }

  const grouped=groupByDay(filtered);
  elMatches.innerHTML=grouped.map(g=>{
    const title=g.dayKey==="unknown"?"Sin fecha":dayTitleFromKey(g.dayKey);
    return `
      <div class="dayHeader">
        <div>
          <div class="title">${title}</div>
          <div class="sub">Partidos del d√≠a</div>
        </div>
        <div class="count">${g.items.length} partidos</div>
      </div>
      ${g.items.map(card).join("")}
    `;
  }).join("");

  elMatches.querySelectorAll(".match").forEach(cardEl=>{
    cardEl.addEventListener("click", ()=>{
      if(lastClickedEl)lastClickedEl.classList.remove("selected");
      cardEl.classList.add("selected");
      lastClickedEl=cardEl;
      const id=cardEl.getAttribute("data-fixture");
      const m=currentData.find(x=>x.id===id);
      if(m)openMatchModal(m);
    });
  });
}

async function loadRoundByIndex(idx){
  roundIndex=idx;
  renderRoundSelector();
  const meta=LEAGUES[active];
  const r=rounds[roundIndex];
  elRoundLabel.textContent=`${roundPretty(r.round)} (${r.status==="current"?"Actual":r.status==="past"?"Pasada":"Futura"})`;
  const j=await api("fixtures",{league:meta.id,season:SEASON,round:r.round});
  currentData=mapFixtures(j);
  renderList(currentData);
}

async function fallbackNextFixtures(){
  const meta=LEAGUES[active];
  elNote.textContent="No hay rounds disponibles. Mostrando pr√≥ximos partidos‚Ä¶";
  const j=await api("fixtures",{league:meta.id,season:SEASON,next:15});
  currentData=mapFixtures(j);
  elRoundLabel.textContent="Pr√≥ximos";
  renderList(currentData);
}

async function refresh(){
  try{
    const meta=LEAGUES[active];
    elNote.textContent="Cargando‚Ä¶";

    if(mode==="live"){
      elRoundLabel.textContent="‚Äî";
      const j=await api("fixtures",{league:meta.id,season:SEASON,live:"all"});
      currentData=mapFixtures(j);
      elNote.textContent="OK: LIVE.";
      renderList(currentData);
      return;
    }

    const roundsRaw=await getRoundsRaw(active);
    if(!roundsRaw.length){ await fallbackNextFixtures(); return; }

    const currentRound=await detectCurrentRound(active);
    const currentIdx=Math.max(0, roundsRaw.indexOf(currentRound));

    rounds=roundsRaw.map((round,idx)=>({ round,index:idx,status: idx<currentIdx?"past":(idx===currentIdx?"current":"future") }));
    roundIndex=currentIdx;
    renderRoundSelector();
    await loadRoundByIndex(roundIndex);
    elNote.textContent="OK.";
  }catch(err){
    elMatches.innerHTML = `<div class="empty">Error cargando datos.<br><br><span style="opacity:.8">${String(err)}</span></div>`;
    elNote.textContent = "Error.";
  }
}

/* ===== UI Wiring ===== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.setAttribute("aria-selected","false"));
    tab.setAttribute("aria-selected","true");
    active=tab.dataset.league;
    await refresh();
  });
});
document.getElementById("search").addEventListener("input",(e)=>{ query=e.target.value.trim(); renderList(currentData); });
roundSelect.addEventListener("change", e => loadRoundByIndex(Number(e.target.value)));
prevRoundBtn.addEventListener("click", ()=>{ if(roundIndex>0)loadRoundByIndex(roundIndex-1); });
nextRoundBtn.addEventListener("click", ()=>{ if(roundIndex<rounds.length-1)loadRoundByIndex(roundIndex+1); });
modeBtn.addEventListener("click", async ()=>{
  mode=(mode==="round")?"live":"round";
  modeBtn.textContent=`Modo: ${mode==="round"?"JORNADA":"LIVE"}`;
  await refresh();
});
refreshBtn.addEventListener("click", ()=> refresh());

setInterval(()=>{ if(mode==="live")refresh(); }, 60000);

refresh();
</script>
</body>
</html>
